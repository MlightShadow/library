# SPRING CLOUD

## 背景

1. 单体架构: 小项目没啥问题，都写一起
2. 垂直架构: 拆分了一部分系统
3. 分布式架构: 分布式服务，调用开始困难了
4. SOA架构: 统一管理服务，方便调用，但是有中心化强耦合的问题
5. 微服务: 松散的中心化

## 基础概念(微服务搭建需要哪些组件)

### 配置中心

对各个服务的配置进行统一的管理

主要功能
* 统一管理: 配置中心负责配置的增删改查，相关服务则通过集成的控制中心客户端从配置中心拉取相关配置
* 区分环境: 能够根据不同环境区分不同的配置
* 实时刷新: 当配置发生变更时，客户端应当实时监听配置改变，从而实时获取，并且不用重新部署
* 权限控制: 不同的用户登录到配置中心需要区分不同的权限（这甚至不应该有疑问）
* 版本控制: 在必要时能够回退到之前的配置
* 灰度发布: 可以发布作用于部分实例，等测试通过后再配置到全部实例

常见配置中心组件

* Spring Cloud Config
* Nacos(alibaba)
* Apollo(携程)
* Consul(google)

### 注册中心

各个服务将自己的服务地址注册到注册中心，消费者在调用时通过注册中心查询其地址然后进行调用

主要功能包含

* 自动注册: 服务启动时通过服务中心的客户端组件将服务相关信息自动注册到注册中心服务端
* 健康检查: 当已经注册的服务宕机后注册中心能够发现并将其删除
* 自动发现: 消费者需要能够实时监测注册中心的信息变更，防止调用时出错

常见的注册中心组件

* Zookeeper
* Eureka
* Nacos(alibaba)
* Consul(google)

### 服务网关

微服务架构中对外的统一入口

主要功能包含

* 高并发: 承担更高的并发量， 保证高性能
* 安全: 权限认证，黑名单，白名单 以保证网关安全
* 路由转发: 根据配置将收到的请求转发到对应的后端服务
* 监控与限流: 监控流量，当遇到突发情况时能及时限流，保证系统的稳定
* 灰度发布: 当某个服务新版本上线时，可以通过网关进行流量切换实现，该服务的灰度发布
* 服务重试: 当调用服务失败时可以根据设置的重试策略来对该服务进行再次尝试
* 服务别名: 在网关中可以对服务设置别名，屏蔽对外的服务信息

常见微服务网关组件

* Kong
* Zuul
* Spring Cloud Gateway

### 负载均衡

将访问流量通过算法进行分发，提高后端服务的可用性及性能

常见算法
* 轮询
    * 简单轮询: 按顺序进行分发，对当前服务器性能及负载状态不关心
    * 加权轮询: 根据服务器的性能设置不同的权重, 性能高的可以多分配请求, 接下来以顺序方式进行分发
* 随机
    * 简单随机: 随机分发，当请求多时，各个服务器接收到的越平均
    * 加权随机: 根据性能设置权重然后随机分发
* 一致性哈希: 通过请求的ip或者其他属性，进行hash算法，之后映射到特定服务器，这样能保证同一客户端总是请求的同一台服务器
* 最小活跃数: 统计服务器的负载状态，将请求分发给请求最少的服务器

常见负载均衡组件

* nginx
* lvs
* ribbon


### RPC调用

远程过程调用, 进程之间就是进程中调用, java中是远程方法调用，微服务中是一个服务调用另一个服务，electron中渲染进行和后端进行调用

RPC调用相比HTTP调用更加灵活，可以自定义格式及协议，只要能保证调用到方法即可

常见的RPC调用哪个组件或者框架

* Dubbo
* gRPC
* Thrift
* Feign

### 服务熔断

当服务A调用的服务B已经不可用时，服务A不再对服务B进行调用而直接返回结果，从而降低对两者的压力, 直到服务B恢复

实现熔断功能的组件叫做熔断器

熔断器的三种状态
* Closed:关闭， 正常调用， 当失败次数达到阈值则启动熔断器 进入打开状态
* Open:打开， 不进行调用， 直接返回失败，不再调用下游服务, 过一段时间进入半打开状态
* Half-Open: 半打开, 部分请求进行调用下游服务，如果这些请求成功了则关闭熔断器，否则回到打开状态

常见熔断器
* Hystrix
* Sentinel



### 服务降级

当发现系统过载时，可以通过关闭或者限流某些服务来降低系统压力

服务降级与熔断的同异

* 都是为了防止系统崩溃
* 用户都感觉某些功能不可用
* 熔断是由于下游服务故障触发，降级是为了降低系统负载

### 服务雪崩

A服务调用B服务，B服务调用C 此时突然大量请求调用A，A能抗住这些调用，但是由于C不能从而导致请求堆积，继而B服务请求堆积，导致A服务不可用

解决方法就是，服务降级和熔断

### 服务限流

高并发下，为了保护系统对访问请求进行数量上的限制从而防止系统被大量请求压垮

* 固定窗口计数器
* 滑动窗口技术器
* 令牌桶
* 漏桶

### 全局锁

即分布式锁, 可以通过该锁在分布式系统中互斥使用共享资源

常见实现方法

* Zookeeper: 利用watch机制与临时节点特性
* Redis: 利用消费订阅机制与数据超时特性

常见实现组件
* Redission
* Curator

### 控制总线

即消息总线，用来连接所有服务节点，所有服务节点都通过控制总线来进行通讯
服务可以通过控制总线来进行广播事件，其他服务可以接收到事件进行相关处理

常见组件：
* Spring Cloud Bus


### 分布式事务

一次请求中涉及的分散在多个服务上的操作要保证同时成功或者同时失败

事务中的三个角色：
* 事务协调器
* 事务管理者
* 资源管理者

常见实现方式
* 通过数据库
* 通过消息队列
* 两阶段提交
* 三阶段提交

常见框架
* seata
* icn
* bytetcc

### 服务安全

对服务进行认证和授权

常见功能

* 可扩展，可配置的认证和授权
* 单点登录
* 防止会话固定，点击劫持，跨网站请求伪造攻击
* 与Servlet API集成

### 链路追踪

为微服务系统提供了完整的调用链路还原，调用统计，链路拓扑，应用依赖分析等，提供快速分析与微服务性能瓶颈的诊断


常见功能

* 分布式调用链查询
* 应用性能实时汇总
* 分布式拓扑动态发现
* 多语言开发程序接入
* 丰富的校友对接场景

常见技术
* Sleuth
* Zipkin

### 集群管理

对某一服务集群提供针对集群管理的功能

常见功能

* 领导者选举
* 一致性存储
* 集群状态管理
* 一次性tokens

常见组件

* Spring Cloud Cluster

### 事件驱动

即消息驱动，通过事件驱动可以更方便的发送消息来进行通信

一些概念
* 目标绑定器: 目标指的是kafka或者rabbitmq 这类消息系统
* 绑定桥梁: 连接消息系统和应用程序
* 消息: 应用程序和消息系统之间传递数据

常见功能
* 异步处理
* 流量削峰
* 服务解耦


常见组件
* Spring Cloud Stream

### 云连接器

方便连接部署在云上的各种服务

支持的云平台
* Spring Cloud Cloud Foundry
* Spring Cloud Heroku

常见组件

* Spring Cloud Connectors

### 函数计算

即函数式编程， 实现serverless的一种手段 

功能
* 支持响应式编程风格
* 输入输出类型透明转化
* 流数据处理
* 同一个jvm中运行多个版本的函数
* 打包函数到指定云平台

### CAP

C 一致性
A 可用性
P 分区容错性

保证可用性做集群会保障到 AP两个特性， 但是一致性会降低
保证一致性的需要做主从架构，就没法保证可用性 这样就是只有CP

常见组件

* Spring Cloud Function

## Spring Cloud Alibaba

添加spring cloud alibaba dependencies依赖, 注意版本对应关系
spring cloud alibaba 类似 spring boot starter parent 包含一个版本仲裁中心 (spring boot dependencies)

通过 pom文件中的 dependencyManagement 实现继承 ,一般自定义的parent都习惯使用这种方式

可以在 [spring could alibaba初始化向导](https://start.aliyun.com/bootstrap.html) 在线配置一份配置

### Nacos

下载Nacos服务项目代码(Github release)

默认为集群形式，在/bin/startup.sh启动脚本中将mode='cluster' 改为 standalone
/conf/application.properties 更改一些配置信息, 默认启动后实在内存，不进行数据持久化

默认登陆名密码都是nacos

核心功能：
* 服务注册: 客户端注册到Nacos
* 服务心跳: 服务默认5秒发送一次心跳
* 服务同步: 多个Nacos服务之间同步信息
* 服务发现: 消费者拉取Nacos服务列表
* 服务健康检查: 15秒未收到服务心跳健康状态为false 30秒无心跳移除


#### 服务注册/发现 Nacos Discovery

项目添加 pom 添加 Nacos 依赖客户端 spring cloud starter alibaba nacos discovery

application.yml
```yaml
spring:
    application:
        name: test-server #注册名称

    cloud: 
        nacos: 
            server-addr: lcoalhost:8848
            discovery: 
                username: nacos
                password: nacos
                namespace: namespace #用于隔离
                ephemeral: false #是否为临时实例，false 表示为永久实例，服务down掉之后也不会在列表中删除
```

@EnableDiscoveryClient 这注解以前要加， 新版本的SpringCloud不需要了，应该是1.4版本

这样服务启动时会自动注册

RestTemplate调用时通过添加@LoadBalance注解添加负载均衡调用, 负载均衡器可以帮助Nacos解析调用服务名称到地址

此时调用时只需要通过配置文件中注册时的服务名称`http://test-server/...`即可

默认负载均衡为权重轮询(Ribbon提供)

Nacos界面管理的一些属性：
* 保护阈值： 当实例可用比低于阈值，不可用实例也会被分配到任务从而防止雪崩
* 权重： 权重越大负载均衡分配访问越多

Nacos中心下线服务，由于客户端拉取有延迟， 短时间内还可以访问当已下线的应用

订阅者列表可以看到消费者的信息

#### 分布式配置 Nacos Config



### 服务熔断 Sentinel
### 服务调用 Dubbo RPC / OpenFeign
### 服务路由 Dubbo + Servlet
### 分布式消息 SCS RocketMQ Binder
### 消息总线 RocketMQ Bus
### 负载均衡 Dubbo LoadBalance / Ribbon (Nacos集成)
### 分布式事务 Seata
### 分布式调度 Sidecar
### Skywalking

